#!/usr/bin/env perl
use 5.14.0;
use warnings;
use utf8::all;
use Anki::Corpus;

die "usage: $0 query\n" unless @ARGV;
my $query;
my $regex = '(?!)';
my @positive;
my @negative;

for my $clause (@ARGV) {
    if ($clause =~ s/^-//) {
        push @negative, $clause;
    }
    else {
        push @positive, $clause;
        $regex .= "|\Q$clause\E";
    }
}

if (@positive) {
    $query .= ' AND (' . join (' OR ', map { "japanese LIKE '%$_%'" } @positive ) . ')';
}
if (@negative) {
    $query .= ' AND (' . join (' AND ', map { "japanese NOT LIKE '%$_%'" } @negative ) . ')';
}

my $corpus = Anki::Corpus->new;
my $count = $corpus->print_each("
    WHERE suspended=1 $query
;", sub { 1 }, $regex);

if (!$count) {
    say "No suspended results, showing unsuspended rows:";
    $corpus->print_each("
        WHERE suspended=0 $query
    ;", sub { 1 }, $regex);
}
