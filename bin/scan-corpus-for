#!/usr/bin/env perl
use 5.14.0;
use warnings;
use utf8::all;
use Anki::Corpus;
use Term::ReadKey;
use Clipboard;

die "usage: $0 query\n" unless @ARGV;

ReadMode 3;
END { ReadMode 0 }

my $corpus = Anki::Corpus->new;

my %commands = (
    "s" => sub { $corpus->suspend_sentence(shift) },
    "u" => sub { $corpus->unsuspend_sentence(shift) },
    "q" => sub { exit },
    "N" => sub {
        my ($id, $sentence, $translation, $readings, $source) = @_;
        Clipboard->copy($sentence);
        say "Copied: $sentence";
    },
    "S" => sub {
        my ($id, $sentence, $translation, $readings, $source) = @_;
        Clipboard->copy($source);
        say "Copied: $source";
    },
);
my $commands = join '', sort keys %commands;

my $cb = sub {
    my $fields = $_[0];

    print "\e[2J";

    while (1) {
        $corpus->print_sentence(@_);

        local $| = 1;
        print "Command [$commands]: ";

        my $command = ReadKey 0;
        exit if !defined($command);
        print "$command\n";
        print "\n" if $command ne "\n";
        last if $command eq "\n" || $command eq " ";

        $commands{$command}->(@$fields);
    }
};

my $count = $corpus->scan_for([@ARGV], $cb, 'WHERE suspended=1');

if (!$count) {
    say "No suspended results, showing unsuspended rows";
    $corpus->scan_for([@ARGV], $cb, 'WHERE suspended=0');
}

